
# [Go 编译器简介](https://github.com/golang/go/tree/master/src/cmd/compile)
cmd/compile包含构成Go编译器的主要包。编译器在逻辑上可以分为四个阶段，我们将在包含其代码的包列表旁边简要描述这些阶段。  

在提到编译器时，您有时可能会听到“前端”和“后端”这两个术语。粗略地说，这些转化为我们将在此处列出的前两个和最后两个阶段。第三个术语“中端”通常是指第二阶段发生的大部分工作。    

请注意，`go/*`包系列，例如`go/parserand`和`go/types`，与编译器无关。由于编译器最初是用C编写的，因此开发了`go/*`这些包以支持编写工具使用Go代码，例如`gofmt`和`vet`。    

需要说明的是，“gc”代表“Go compiler”，与大写的“GC”关系不大，GC代表垃圾收集。  

## 1.解析(Parsing)  
- `cmd/compile/internal/syntax` （词法分析器，解析器，语法树）  
在编译的第一阶段，对源代码进行标记（词法分析）、解析（语法分析），并为每个源文件构建语法树。  
每个语法树都是相应源文件的精确表示，其节点对应于源文件的各种元素，例如表达式、声明和语句。语法树还包括用于错误报告和创建调试信息的位置信息。  

## 2. 类型检查和AST转换(Type-checking and AST transformations)
- `cmd/compile/internal/gc` （创建编译器AST、类型检查、AST转换）  
从它用C编写时开始，gc包包含一个AST定义。它的所有代码都是根据它编写的，所以gc包必须做的第一件事是将语法包的语法树转换为编译器的AST表示. 这个额外的步骤将来可能会被重构掉。  
然后对AST进行类型检查。第一步是名称解析和类型推断，它们确定哪个对象属于哪个标识符，以及每个表达式具有什么类型。类型检查包括某些额外的检查，例如“声明和未使用”以及确定函数是否终止。  
某些转换也在AST上完成。一些节点根据类型信息进行细化，例如字符串加法从算术加法节点类型中分离出来。其他示例如死代码消除、函数调用内联和转义分析。  

## 3. 通用 SSA(Generic SSA)
- `cmd/compile/internal/gc` （转换为 SSA）
- `cmd/compile/internal/ssa` （SSA 通行证和规则）
在此阶段，AST被转换为静态单分配 (SSA) 形式，这是一种具有特定属性的较低级别的中间表示，可以更轻松地实现优化并最终从中生成机器代码。  
在此转换期间，将应用内在函数。这些是编译器被教导要根据具体情况用高度优化的代码替换的特殊函数。  
在AST到SSA转换期间，某些节点也被降低为更简单的组件，以便编译器的其余部分可以使用它们。例如，内建的copy被内存移动取代，范围循环被重写为for循环。由于历史原因，其中一些目前在转换为SSA之前发生，但长期计划是将它们全部移到这里。  
然后，应用一系列与机器无关的通行证和规则。这些不涉及任何单一的计算机体系结构，因此可以在所有GOARCH变体上运行。  
这些通用传递的一些示例包括死代码消除、删除不需要的nil检查和删除未使用的分支。通用重写规则主要涉及表达式，例如将某些表达式替换为常量值，以及优化乘法和浮点运算。  

## 4. 生成机器码(Generating machine code)  
- `cmd/compile/internal/ssa` (SSA 降低和特定于拱门的通行证)(SSA lowering and arch-specific passes)
- `cmd/internal/obj` （机器码生成）(machine code generation)
编译器的机器相关阶段从“较低”阶段开始，它将通用值重写为特定于机器的变体。例如，在 md6 内存操作数上是可能的，因此可以组合许多加载-存储操作。  
请注意，lower pass 运行所有特定于机器的重写规则，因此它目前也应用了许多优化。  
一旦 SSA 被“降低”并且更加特定于目标架构，就会运行最终的代码优化通道。这包括另一个死代码消除过程，将值移动到更接近它们的用途，删除从未读取的局部变量以及寄存器分配。  
作为此步骤的一部分完成的其他重要工作包括堆栈帧布局，它将堆栈偏移分配给局部变量，以及指针活跃度分析，它计算每个GC安全点上哪些堆栈上指针是活跃的。  
在 SSA 生成阶段结束时，Go 函数已转换为一系列 obj.Prog 指令。这些被传递给汇编器 ( `cmd/internal/obj`)，汇编器将它们转换为机器代码并写出最终的目标文件。目标文件还将包含反射数据、导出数据和调试信息。  

## 进一步阅读
要深入了解 SSA 包的工作原理，包括其传递和规则，请前往[cmd/compile/internal/ssa/README.md](https://github.com/golang/go/blob/master/src/cmd/compile/internal/ssa/README.md)  

  